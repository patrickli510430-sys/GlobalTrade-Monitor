<!-- 
  ========================================
  Project: GlobalTrade Monitor
  File:    dashboard.html
  Author:  [Wenxuan Li]
  Date:    2025-12-18
  Description: 
      Core dashboard template utilizing HTMX for 
      real-time updates and Alpine.js for interactions.
  ========================================
-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalTrade Flux | Êô∫ËÉΩË∑®Â¢ÉÁúãÊùø</title>
    
    <!-- Âü∫Á°ÄÂ∫ì -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Alpine.js (Á°Æ‰øùÂú® head ‰∏≠Âä†ËΩΩ) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        [x-cloak] { display: none !important; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { animation: marquee 30s linear infinite; }
        .glass-card {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        body { background-color: #fbfbfd; font-family: ui-sans-serif, system-ui, sans-serif; }
        aside, .menu-text { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* ËøõÂ∫¶Êù°‰∏éÂä®Áîª */
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { opacity: 1; }
        #main-content { transition: opacity 300ms ease-in-out, transform 300ms ease-in-out; opacity: 1; transform: translateY(0); }
        .htmx-swapping #main-content { opacity: 0; transform: translateY(10px); }
        .htmx-settling #main-content { opacity: 1; transform: translateY(0); }
    </style>
</head>

<!-- üü¢ 1. body ‰øùÊåÅÂπ≤ÂáÄÔºåÊ≤°Êúâ‰ªª‰Ωï x-data -->
<body class="text-slate-900 antialiased h-screen flex flex-col overflow-hidden">

    <!-- ÂÖ®Â±ÄËøõÂ∫¶Êù° -->
    <div id="global-progress" class="htmx-indicator fixed top-0 left-0 w-full h-1 bg-indigo-100 z-[100]">
        <div class="h-full bg-indigo-600 animate-[progress_2s_infinite]"></div>
    </div>
    <style>@keyframes progress { 0% { width: 0%; margin-left: 0; } 50% { width: 70%; margin-left: 0; } 100% { width: 100%; margin-left: 100%; } }</style>

    <!-- üü¢ 2. Êñ∞Â¢ûÔºöÂÖ®Â±èÂ∏ÉÂ±ÄÂÆπÂô® ID="layout-root" -->
    <!-- Â∞Ü x-data Âíå x-init ÁßªÂà∞ËøôÈáåÔºåÂπ∂‰Ωú‰∏∫ HTMX ÊõøÊç¢ÁöÑÁõÆÊ†á -->
    <div id="layout-root" 
         class="flex-1 flex flex-col h-full overflow-hidden relative"
         x-data="{ sidebarOpen: localStorage.getItem('sidebarState') === 'false' ? false : true }"
         x-init="$watch('sidebarOpen', value => localStorage.setItem('sidebarState', value))">

        <!-- È°∂ÈÉ® Ticker -->
        <div class="w-full bg-black text-white h-10 flex items-center overflow-hidden font-mono text-xs relative shrink-0 z-50">
            <div class="absolute left-0 top-0 bottom-0 bg-indigo-600 px-4 flex items-center z-10 font-black italic tracking-tighter">LIVE DATA</div>
            <div hx-get="/api/ticker" hx-trigger="load, every 60s" hx-swap="innerHTML" class="flex w-full">
                <div class="flex animate-marquee whitespace-nowrap gap-16 pl-32 items-center"><span>Loading market data...</span></div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden relative">
            
            <!-- ‰æßËæπÊ†è -->
            <aside class="bg-white/40 backdrop-blur-3xl border-r border-slate-200/50 flex flex-col gap-8 h-full shrink-0 z-40 transition-all duration-300 relative"
                   :class="sidebarOpen ? 'w-72 p-8' : 'w-20 p-4 items-center'">
                
                <!-- Logo & Toggle -->
                <div class="flex items-center gap-3 px-2 h-10 w-full relative">
                    <button @click="sidebarOpen = !sidebarOpen" 
                            class="absolute -right-4 top-1 bg-white border border-slate-200 rounded-full p-1.5 shadow-sm text-slate-400 hover:text-indigo-600 transition-colors z-50 hidden md:block"
                            :class="sidebarOpen ? '' : 'rotate-180 -right-10'">
                        <i class="fa-solid fa-chevron-left text-xs"></i>
                    </button>
                    <div class="bg-black w-10 h-10 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-slate-200 shrink-0 transition-transform duration-300"
                         :class="sidebarOpen ? '' : 'scale-90'">
                        <i class="fa-solid fa-globe text-lg"></i>
                    </div>
                    <span class="font-black text-2xl tracking-tighter uppercase italic overflow-hidden whitespace-nowrap"
                          x-show="sidebarOpen" x-transition>{{ t.nav_title if t and t.nav_title else 'Flux' }}</span>
                </div>

                <!-- ÂØºËà™ËèúÂçï -->
                <nav class="flex flex-col gap-3 w-full" 
                     x-data="{ currentPath: window.location.pathname }"
                     @popstate.window="currentPath = window.location.pathname"
                     @htmx:pushed-into-history.window="currentPath = window.location.pathname"
                     hx-boost="true" 
                     hx-target="#main-content" 
                     hx-select="#main-content" 
                     hx-swap="outerHTML show:top"
                     hx-indicator="#global-progress">
                    
                    <a href="/" class="w-full flex items-center gap-3 rounded-2xl transition-all group overflow-hidden whitespace-nowrap relative"
                       :class="currentPath === '/' ? 'bg-black text-white shadow-2xl' : 'text-slate-500 hover:bg-white hover:shadow-lg'"
                       :style="sidebarOpen ? 'padding: 1rem 1.25rem;' : 'padding: 0.75rem; justify-content: center; aspect-ratio: 1/1;'">
                        <i class="fa-solid fa-chart-line w-5 text-center text-lg"></i> 
                        <span class="font-bold transition-opacity duration-200" x-show="sidebarOpen" x-transition>{{ t.nav_dashboard }}</span>
                        <div x-show="!sidebarOpen" class="absolute left-16 bg-slate-900 text-white text-xs font-bold px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 whitespace-nowrap">{{ t.nav_dashboard }}</div>
                    </a>
                    
                    <a href="/inventory" class="w-full flex items-center gap-3 rounded-2xl transition-all group overflow-hidden whitespace-nowrap relative"
                       :class="currentPath.includes('/inventory') ? 'bg-black text-white shadow-2xl' : 'text-slate-500 hover:bg-white hover:shadow-lg'"
                       :style="sidebarOpen ? 'padding: 1rem 1.25rem;' : 'padding: 0.75rem; justify-content: center; aspect-ratio: 1/1;'">
                        <i class="fa-solid fa-box-open w-5 text-center text-lg"></i> 
                        <span class="font-bold transition-opacity duration-200" x-show="sidebarOpen" x-transition>{{ t.nav_inventory }}</span>
                        <div x-show="!sidebarOpen" class="absolute left-16 bg-slate-900 text-white text-xs font-bold px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 whitespace-nowrap">{{ t.nav_inventory }}</div>
                    </a>
                    
                    <a href="/settings" class="w-full flex items-center gap-3 rounded-2xl transition-all group overflow-hidden whitespace-nowrap relative"
                       :class="currentPath.includes('/settings') ? 'bg-black text-white shadow-2xl' : 'text-slate-500 hover:bg-white hover:shadow-lg'"
                       :style="sidebarOpen ? 'padding: 1rem 1.25rem;' : 'padding: 0.75rem; justify-content: center; aspect-ratio: 1/1;'">
                        <i class="fa-solid fa-gear w-5 text-center text-lg"></i> 
                        <span class="font-bold transition-opacity duration-200" x-show="sidebarOpen" x-transition>{{ t.nav_settings }}</span>
                        <div x-show="!sidebarOpen" class="absolute left-16 bg-slate-900 text-white text-xs font-bold px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 whitespace-nowrap">{{ t.nav_settings }}</div>
                    </a>
                </nav>

                <!-- Â∫ïÈÉ®Âå∫Âüü (ËØ≠Ë®ÄÂàáÊç¢) -->
                <div class="mt-auto flex flex-col gap-4 w-full">
                    <!-- üü¢ 3. ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆÔºöÁõÆÊ†áÊîπ‰∏∫ #layout-root -->
                    <!-- 
                         hx-target="#layout-root": ÊõøÊç¢Êï¥‰∏™ÂÆπÂô®Ôºå‰ª•Êõ¥Êñ∞ÊâÄÊúâÊñáÊú¨
                         hx-select="#layout-root": ‰ªéÂìçÂ∫î‰∏≠Âè™ÊèêÂèñËøô‰∏™ÂÆπÂô®
                         hx-swap="outerHTML": ÂÆåÂÖ®ÊõøÊç¢ÊóßÂÆπÂô®ÔºåËß¶Âèë Alpine ÈáçÊñ∞ÂàùÂßãÂåñ
                    -->
                    <div hx-get="/api/set-lang/{{ 'en' if current_lang == 'zh' else 'zh' }}" 
                         hx-target="#layout-root"
                         hx-select="#layout-root"
                         hx-swap="outerHTML"
                         hx-indicator="#global-progress"
                         class="cursor-pointer flex items-center justify-center gap-2 bg-slate-100 rounded-2xl font-bold text-slate-600 hover:bg-slate-200 transition-all active:scale-95 text-xs uppercase tracking-wider relative group"
                         :class="sidebarOpen ? 'py-3 px-4' : 'p-3 aspect-square'">
                        <i class="fa-solid fa-language text-lg"></i> 
                        <span x-show="sidebarOpen" class="whitespace-nowrap">{{ t.switch_lang if t else 'Switch Language' }}</span>
                        <div x-show="!sidebarOpen" class="absolute left-16 bg-slate-900 text-white text-xs font-bold px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 whitespace-nowrap">{{ t.switch_lang if t else 'Switch Language' }}</div>
                    </div>

                    <div class="rounded-[2rem] bg-indigo-600 text-white shadow-2xl shadow-indigo-200 relative overflow-hidden group cursor-pointer hover:scale-105 transition-transform"
                         :class="sidebarOpen ? 'p-6' : 'p-2 aspect-square flex items-center justify-center'">
                        <div class="absolute top-0 right-0 p-8 opacity-10 group-hover:opacity-20 transition-opacity" x-show="sidebarOpen"><i class="fa-solid fa-arrow-trend-up text-6xl"></i></div>
                        <div class="flex flex-col" :class="sidebarOpen ? '' : 'items-center'">
                            <div class="text-[10px] font-black uppercase tracking-widest text-indigo-200 mb-2 whitespace-nowrap" x-show="sidebarOpen">System Status</div>
                            <div class="text-lg font-bold flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse shadow-[0_0_10px_#4ade80]"></div> 
                                <span x-show="sidebarOpen">{{ t.nav_status_online }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
            <main class="flex-1 overflow-y-auto overflow-x-hidden scroll-smooth bg-slate-50/30 relative">
                <button @click="sidebarOpen = !sidebarOpen" class="md:hidden absolute top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg text-slate-600"><i class="fa-solid fa-bars"></i></button>
                <div id="main-content" class="max-w-[1600px] mx-auto w-full p-8 md:p-12 transition-all duration-300">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div> <!-- /#layout-root -->

    <script>
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Toast ÊèêÁ§∫
            if (evt.detail.xhr.status === 200 && evt.detail.target.id.includes("row-")) {
                const Toast = Swal.mixin({
                    toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000,
                    customClass: { popup: 'rounded-2xl shadow-2xl border border-slate-100' }
                });
                Toast.fire({ icon: 'success', title: 'Operation completed' });
            }
            // ‰øÆÂ§çÂõæË°®Â∞∫ÂØ∏
            setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 100);
        });
    </script>
</body>
</html>